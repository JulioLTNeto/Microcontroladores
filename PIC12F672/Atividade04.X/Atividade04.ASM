;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
;*              MODIFICAÇÕES PARA USO COM 12F675                   *
;*                FEITAS PELO PROF. MARDSON                        *
;*                     SETEMBRO DE 2022                            *
;*                 BASEADO NO EXEMPLO DO LIVRO                     *
;*           Desbravando o PIC. David José de Souza                *
;*-----------------------------------------------------------------*
;*   MODELO PARA O PIC 12F675                                      *
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
;*                     ARQUIVOS DE DEFINIÇÕES                      *
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
#INCLUDE <p12f675.inc>	;ARQUIVO PADRÃO MICROCHIP PARA 12F675

	__CONFIG _BODEN_OFF & _CP_OFF & _PWRTE_ON & _WDT_OFF & _MCLRE_OFF & _INTRC_OSC_NOCLKOUT

;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
;*                    PAGINAÇÃO DE MEMÓRIA                         *
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
;DEFINIÇÃO DE COMANDOS DE USUÁRIO PARA ALTERAÇÃO DA PÁGINA DE MEMÓRIA
#DEFINE	BANK0	BCF STATUS,RP0	;SETA BANK 0 DE MEMÓRIA
#DEFINE	BANK1	BSF STATUS,RP0	;SETA BANK 1 DE MAMÓRIA

;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
;*                         VARIÁVEIS                               *
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
; DEFINIÇÃO DOS NOMES E ENDEREÇOS DE TODAS AS VARIÁVEIS UTILIZADAS 
; PELO SISTEMA

	CBLOCK	0x20	;ENDEREÇO INICIAL DA MEMÓRIA DE
					;USUÁRIO
		W_TEMP		;REGISTRADORES TEMPORÁRIOS PARA USO
		STATUS_TEMP	;JUNTO ÀS INTERRUPÇÕES

		;COLOQUE AQUI SUAS NOVAS VARIÁVEIS
		;NÃO ESQUEÇA COMENTÁRIOS ESCLARECEDORES
		
		CONTADOR	;0x22
		ESTADO_SINAL	;0x23

	ENDC			;FIM DO BLOCO DE DEFINIÇÃO DE VARIÁVEIS

;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
;*                        FLAGS INTERNOS                           *
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
; DEFINIÇÃO DE TODOS OS FLAGS UTILIZADOS PELO SISTEMA

;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
;*                         CONSTANTES                              *
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
; DEFINIÇÃO DE TODAS AS CONSTANTES UTILIZADAS PELO SISTEMA

;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
;*                           ENTRADAS                              *
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
; DEFINIÇÃO DE TODOS OS PINOS QUE SERÃO UTILIZADOS COMO ENTRADA
; RECOMENDAMOS TAMBÉM COMENTAR O SIGNIFICADO DE SEUS ESTADOS (0 E 1)

;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
;*                           SAÍDAS                                *
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
; DEFINIÇÃO DE TODOS OS PINOS QUE SERÃO UTILIZADOS COMO SAÍDA
; RECOMENDAMOS TAMBÉM COMENTAR O SIGNIFICADO DE SEUS ESTADOS (0 E 1)

;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
;*                       VETOR DE RESET                            *
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

	ORG	0x00			;ENDEREÇO INICIAL DE PROCESSAMENTO
	GOTO	INICIO
	
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
;*                    INÍCIO DA INTERRUPÇÃO                        *
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
; ENDEREÇO DE DESVIO DAS INTERRUPÇÕES. A PRIMEIRA TAREFA É SALVAR OS
; VALORES DE "W" E "STATUS" PARA RECUPERAÇÃO FUTURA

	ORG	0x04			;ENDEREÇO INICIAL DA INTERRUPÇÃO
	MOVWF	W_TEMP		;COPIA W PARA W_TEMP
	SWAPF	STATUS,W
	MOVWF	STATUS_TEMP	;COPIA STATUS PARA STATUS_TEMP

;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
;*                    ROTINA DE INTERRUPÇÃO                        *
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
	BTFSS	INTCON,T0IF	;FAZ A VERIFICAÇÃO SE A INTERRUPÇÃO FOI FEITA PELO TMR0
	GOTO	SAIU		;VAI PARA SAIU
	
;INICIO DOS IFS PARA A SAIDA DO GPIO, CADA BLOCO DE INSTRUÇÕES É RESPONSÁVEL POR VERIFICAR O VALOR DA VARIÁVEL CONTADOR E GERAR UMA SAIDA DO GPIO PERTINENTE
	;ESSE BLOCO FAZ A VERIFICAÇÃO SE CONTADOR É IGUAL A 1
	MOVLW	.1
	SUBWF	CONTADOR,W  ;SUBTRAI 1 DE CONTADOR, PARA VERIFICAR SE O RESULTADO É 0
	
	BTFSS	STATUS,Z    ;FAZ A VERIFICAÇÃO, SE A SUBTRAÇÃO NÃO DEU 0, ENTÃO O SISTEMA NÃO PULA A LINHA
	GOTO	IF_2	    ;PULA PARA O IF_2
	
	MOVLW	.00000001   ;CONJUNTO DE BITS PARA SALVAR NO GPIO, 0001 - PARA O BCP: 1
	MOVWF	GPIO	    ;SALVANDO AS SAIDAS DAS PORTAS NO GPIO, A PORTA 3 E 2 SÃO ENTRADAS, ENTÃO ELAS NÃO IMPORTAM
	
	MOVLW	.0	    
	MOVWF	CONTADOR    ;RESETA O CONTADOR
	
;VERIFICA SE O CONTADOR É IGUAL A 2
IF_2
	MOVLW	.2	    
	SUBWF	CONTADOR,W  ;SUBTRAI 2 DE CONTADOR, PARA VERIFICAR SE O RESULTADO É 0
	
	BTFSS	STATUS,Z    ;FAZ A VERIFICAÇÃO, SE A SUBTRAÇÃO NÃO DEU 0, ENTÃO O SISTEMA NÃO PULA A LINHA
	GOTO	IF_3	    ;PULA PARA O IF_3
	
	MOVLW	.00000010   ;CONJUNTO DE BITS PARA SALVAR NO GPIO, 0010 - PARA O BCP: 2
	MOVWF	GPIO	    ;SALVANDO AS SAIDAS DAS PORTAS NO GPIO, A PORTA 3 E 2 SÃO ENTRADAS, ENTÃO ELAS NÃO IMPORTAM
	
	MOVLW	.0
	MOVWF	CONTADOR    ;RESETA O CONTADOR

;VERIFICA SE O CONTADOR É 3
IF_3
	MOVLW	.3
	SUBWF	CONTADOR,W  ;SUBTRAI 3 DE CONTADOR, PARA VERIFICAR SE O RESULTADO É 0
	
	BTFSS	STATUS,Z    ;FAZ A VERIFICAÇÃO, SE A SUBTRAÇÃO NÃO DEU 0, ENTÃO O SISTEMA NÃO PULA A LINHA
	GOTO	IF_4	    ;PULA PARA O IF_4
	
	MOVLW	.00000011   ;CONJUNTO DE BITS PARA SALVAR NO GPIO, 0011 - PARA O BCP: 3
	MOVWF	GPIO	    ;SALVANDO AS SAIDAS DAS PORTAS NO GPIO, A PORTA 3 E 2 SÃO ENTRADAS, ENTÃO ELAS NÃO IMPORTAM
	
	MOVLW	.0
	MOVWF	CONTADOR    ;RESETA O CONTADOR

;VERIFICA SE O CONTADOR É 4
IF_4
	MOVLW	.4
	SUBWF	CONTADOR,W  ;SUBTRAI 4 DE CONTADOR, PARA VERIFICAR SE O RESULTADO É 0
	
	BTFSS	STATUS,Z    ;FAZ A VERIFICAÇÃO, SE A SUBTRAÇÃO NÃO DEU 0, ENTÃO O SISTEMA NÃO PULA A LINHA
	GOTO	IF_5	    ;PULA PARA O IF_5
	
	MOVLW	.00010000   ;CONJUNTO DE BITS PARA SALVAR NO GPIO, 0100 - PARA O BCP: 4
	MOVWF	GPIO	    ;SALVANDO AS SAIDAS DAS PORTAS NO GPIO, A PORTA 3 E 2 SÃO ENTRADAS, ENTÃO ELAS NÃO IMPORTAM
	
	MOVLW	.0
	MOVWF	CONTADOR    ;RESETA O CONTADOR

;VERIFICA SE O CONTADOR É 5
IF_5
	MOVLW	.5
	SUBWF	CONTADOR,W  ;SUBTRAI 5 DE CONTADOR, PARA VERIFICAR SE O RESULTADO É 0
	
	BTFSS	STATUS,Z    ;FAZ A VERIFICAÇÃO, SE A SUBTRAÇÃO NÃO DEU 0, ENTÃO O SISTEMA NÃO PULA A LINHA
	GOTO	IF_6	    ;PULA PARA O IF_6
	
	MOVLW	.00010001   ;CONJUNTO DE BITS PARA SALVAR NO GPIO, 0101 - PARA O BCP: 5
	MOVWF	GPIO	    ;SALVANDO AS SAIDAS DAS PORTAS NO GPIO, A PORTA 3 E 2 SÃO ENTRADAS, ENTÃO ELAS NÃO IMPORTAM
	
	MOVLW	.0
	MOVWF	CONTADOR    ;RESETA O CONTADOR
	
;VERIFICA SE O CONTADOR É 6
IF_6
	MOVLW	.6
	SUBWF	CONTADOR,W  ;SUBTRAI 6 DE CONTADOR, PARA VERIFICAR SE O RESULTADO É 0
	
	BTFSS	STATUS,Z    ;FAZ A VERIFICAÇÃO, SE A SUBTRAÇÃO NÃO DEU 0, ENTÃO O SISTEMA NÃO PULA A LINHA
	GOTO	IF_7	    ;PULA PARA O IF_7
	
	MOVLW	.00010010   ;CONJUNTO DE BITS PARA SALVAR NO GPIO, 0110 - PARA O BCP: 6
	MOVWF	GPIO	    ;SALVANDO AS SAIDAS DAS PORTAS NO GPIO, A PORTA 3 E 2 SÃO ENTRADAS, ENTÃO ELAS NÃO IMPORTAM
	
	MOVLW	.0
	MOVWF	CONTADOR    ;RESETA O CONTADOR

;VERIFICA SE O CONTADOR É 7
IF_7
	MOVLW	.7
	SUBWF	CONTADOR,W  ;SUBTRAI 7 DE CONTADOR, PARA VERIFICAR SE O RESULTADO É 0
	
	BTFSS	STATUS,Z    ;FAZ A VERIFICAÇÃO, SE A SUBTRAÇÃO NÃO DEU 0, ENTÃO O SISTEMA NÃO PULA A LINHA
	GOTO	IF_8	    ;PULA PARA O IF_8
	
	MOVLW	.00010011   ;CONJUNTO DE BITS PARA SALVAR NO GPIO, 0111 - PARA O BCP: 7
	MOVWF	GPIO	    ;SALVANDO AS SAIDAS DAS PORTAS NO GPIO, A PORTA 3 E 2 SÃO ENTRADAS, ENTÃO ELAS NÃO IMPORTAM
	
	MOVLW	.0
	MOVWF	CONTADOR    ;RESETA O CONTADOR

;VERIFICA SE O CONTADOR É 8
IF_8
	MOVLW	.8
	SUBWF	CONTADOR,W  ;SUBTRAI 8 DE CONTADOR, PARA VERIFICAR SE O RESULTADO É 0
	
	BTFSS	STATUS,Z    ;FAZ A VERIFICAÇÃO, SE A SUBTRAÇÃO NÃO DEU 0, ENTÃO O SISTEMA NÃO PULA A LINHA
	GOTO	IF_9	    ;PULA PARA O IF_9
	
	MOVLW	.00100000   ;CONJUNTO DE BITS PARA SALVAR NO GPIO, 1000 - PARA O BCP: 8
	MOVWF	GPIO	    ;SALVANDO AS SAIDAS DAS PORTAS NO GPIO, A PORTA 3 E 2 SÃO ENTRADAS, ENTÃO ELAS NÃO IMPORTAM
	
	MOVLW	.0
	MOVWF	CONTADOR    ;RESETA O CONTADOR

;VERIFICA SE O CONTADOR É 9
IF_9
	MOVLW	.9
	SUBWF	CONTADOR,W  ;SUBTRAI 9 DE CONTADOR, PARA VERIFICAR SE O RESULTADO É 0
	
	BTFSS	STATUS,Z    ;FAZ A VERIFICAÇÃO, SE A SUBTRAÇÃO NÃO DEU 0, ENTÃO O SISTEMA NÃO PULA A LINHA
	GOTO	RESETA_TMR0 ;PULA PARA O RESETA_TMR0
	
	MOVLW	.00010001   ;CONJUNTO DE BITS PARA SALVAR NO GPIO, 1001 - PARA O BCP: 9
	MOVWF	GPIO	    ;SALVANDO AS SAIDAS DAS PORTAS NO GPIO, A PORTA 3 E 2 SÃO ENTRADAS, ENTÃO ELAS NÃO IMPORTAM
	
	MOVLW	.0
	MOVWF	CONTADOR    ;RESETA O CONTADOR
	
	
RESETA_TMR0		    ;BLOCO RESPONSAVEL POR RESETAR O TMR0
	MOVLW	.178
	MOVWF	TMR0
	BCF	INTCON,T0IF;RESETA A FLAG DA INTERRUPÇÃO
	
SAIU
;NAO_RESETA_TIMER0
;	BTFSS	GPIO,GP4
;	GOTO	LIGA
;	BCF	GPIO,GP4
;	GOTO	LIMPA_FLAG
;LIGA	BSF	GPIO,GP4
;LIMPA_FLAG
;	BCF	INTCON,GPIF ;VEJA NO DATA SHEET:
			    ;É NECESSÁRIO QUE O "CLEAR" DESTE FLAG SEJA
			    ;COLOCADO APÓS UM "read or write of GPIO"
	
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
;*                 ROTINA DE SAÍDA DA INTERRUPÇÃO                  *
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
; OS VALORES DE "W" E "STATUS" DEVEM SER RECUPERADOS ANTES DE 
; RETORNAR DA INTERRUPÇÃO

SAI_INT
	SWAPF	STATUS_TEMP,W
	MOVWF	STATUS		;MOVE STATUS_TEMP PARA STATUS
	SWAPF	W_TEMP,F
	SWAPF	W_TEMP,W	;MOVE W_TEMP PARA W
	RETFIE

;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
;*	            	 ROTINAS E SUBROTINAS                      *
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
; CADA ROTINA OU SUBROTINA DEVE POSSUIR A DESCRIÇÃO DE FUNCIONAMENTO
; E UM NOME COERENTE ÀS SUAS FUNÇÕES.

SUBROTINA1

	;CORPO DA ROTINA

	RETURN

;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
;*                     INICIO DO PROGRAMA                          *
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
	
INICIO
	BANK1				;ALTERA PARA O BANCO 1
	MOVLW	B'00001100' ;CONFIGURA TODAS AS PORTAS DO GPIO (PINOS)
	MOVWF	TRISIO		;COMO SAÍDAS
	CLRF	ANSEL 		;DEFINE PORTAS COMO Digital I/O
	MOVLW	B'00000111'
	MOVWF	OPTION_REG	;DEFINE OPÇÕES DE OPERAÇÃO
	MOVLW	B'10101000'	;INTERRUPÇÃO GERAL E POR MUDANÇA DE PORTA HABILITADA
	MOVWF	INTCON		;DEFINE OPÇÕES DE INTERRUPÇÕES
	MOVLW	B'00001000'	;INTERRUPÇÃO POR GP3 HABILITADA
	MOVWF	IOC
	BANK0				;RETORNA PARA O BANCO
	MOVLW	B'00000111'
	MOVWF	CMCON		;DEFINE O MODO DE OPERAÇÃO DO COMPARADOR ANALÓGICO

;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
;*                     INICIALIZAÇÃO DAS VARIÁVEIS                 *
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
	MOVLW	.0	;INICIA O CONTADOR COMO 0
	MOVWF	CONTADOR;COLOCA O VALOR 0 NA VARIAVEL CONTADOR
	
	MOVLW	.178	;INICIA O TIMER EM 176, UM VALOR QUE DA APROXIMADAMENTE 20MS
	MOVWF	TMR0	;CONFIGURA O TMR0
	
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
;*                     ROTINA PRINCIPAL                            *
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
MAIN
	BTFSS	GPIO,GP2    ;VERIFICA SE ENTROU EM UM PULSO
	GOTO	RESETA_ESTADO_SINAL ;CHAMA O RESETA_ESTADO_SINAL
	
	;VERIFICA O ESTADO_SINAL, PARA O SISTEMA NÃO FICAR INCREMENTANO A VARIAVEL CONTADOR QUANDO ESTIVER NO MESMO PULSO
	DECF	ESTADO_SINAL,W	;DECREMENTA O VALOR DE ESTADO_SINAL PARA VER SE A VARIAVEL É IGUAL A ZERO, SALVA O VALOR NO WORK
	BTFSS	STATUS,Z	;FAZ A VERIFICAÇÃO DO STATUS, VENDO SE ESTADO_SINAL MENOS 1 É IGUAL A ZERO
				;NÃO PULA SE O RESULTADO FOR 0, JÁ QUE ESTADO_SINAL É 1
	GOTO	INICIO_PULSO	;VAI PARA O INICIO_PULSO
	GOTO	MAIN		;VAI PARA MAIN
	
RESETA_ESTADO_SINAL		;TRECHO RESPONSÁVEL POR SETAR COMO 0 O VALOR DA VARIAVEL ESTADO_SINAL
	MOVLW	.0		;ESSE TRECHO É RESPONSAVEL POR NÃO DEIXAR O PROGRAMA SEMPRE ENTRANDO NO INICIO_PULSO VARIAS VEZES NO MESMO PULSO
	MOVWF	ESTADO_SINAL	
	GOTO	MAIN
	
INICIO_PULSO	    ;ESSE TRECHO É RESPONSAVEL POR CONTABILIZAR A QUANTIDADE DE PULSOS OCORREU, PARA SAIR NO GPIO
	INCF	CONTADOR    ;SOMA O VALOR DO CONTADOR +1
	MOVLW	.1
	MOVWF	ESTADO_SINAL	;ALTERA O ESTADO_SINAL PARA QUE O SISTEMA NÃO ENTRE NESSA SEÇÃO NESSE PULSO
	
	MOVLW	.178	;RESETA A CONTAGEM DO TMR0 PARA ESPERAR MAIS 20MS ANTES DA INTERRUPÇÃO
	MOVWF	TMR0
	
	GOTO	MAIN	;VOLTA PARA A MAIN

;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
;*                       FIM DO PROGRAMA                           *
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

	END
